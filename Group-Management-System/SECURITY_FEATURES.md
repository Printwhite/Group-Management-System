# 安全功能说明

## 云码验证系统

### 概述
本系统已集成云码验证（双因素认证）功能，提供多层安全保护，同时保证老用户的便捷性。

### 主要功能

#### 1. 云码验证（推荐）
- **工作原理**：基于时间的一次性密码（TOTP）
- **支持应用**：Google Authenticator、Microsoft Authenticator、Authy等
- **验证流程**：
  1. 用户注册时选择启用云码验证
  2. 系统生成二维码和备用验证码
  3. 用户扫描二维码绑定云码应用
  4. 每次登录时输入6位动态验证码

#### 2. 备用验证方式
- **短信验证**：发送6位验证码到用户手机
- **邮箱验证**：发送6位验证码到用户邮箱
- **备用验证码**：8个一次性验证码，用于紧急情况

#### 3. 渐进式升级
- **新用户**：注册时可选择是否启用云码验证
- **老用户**：可在安全设置中随时启用/禁用
- **向后兼容**：未启用云码验证的用户仍可正常登录

### 安全特性

#### 1. 多重验证
- 用户名/密码 + 云码验证
- 用户名/密码 + 短信验证
- 用户名/密码 + 邮箱验证
- 用户名/密码 + 备用验证码

#### 2. 安全令牌
- 自动登录cookie使用哈希令牌验证
- 防止cookie被篡改
- 30天有效期，自动清理

#### 3. 会话管理
- 记录最后登录时间
- 记录登录IP地址
- 支持账户状态管理

#### 4. 日志记录
- 记录所有登录尝试（成功/失败）
- 记录安全设置变更
- 记录验证码发送情况

### 使用方法

#### 新用户注册
1. 访问注册页面
2. 填写基本信息（用户名、密码、姓名等）
3. 可选填写邮箱和手机号
4. 勾选"启用云码验证"
5. 完成注册后扫描二维码设置云码应用

#### 老用户启用云码验证
1. 登录系统
2. 访问"安全设置"页面
3. 点击"启用云码验证"
4. 重新登录以完成设置

#### 登录流程
1. 输入用户名和密码
2. 如果启用了云码验证：
   - 输入6位云码验证码，或
   - 选择其他验证方式（短信/邮箱）
3. 验证成功后进入系统

### 技术实现

#### 依赖库
```bash
pip install pyotp qrcode Pillow
```

#### 核心功能
- `pyotp`：生成和验证TOTP码
- `qrcode`：生成云码二维码
- `Pillow`：图像处理支持

#### 数据库字段
```sql
-- 用户表新增字段
email VARCHAR(120)          -- 邮箱地址
phone VARCHAR(20)           -- 手机号码
cloud_code_enabled BOOLEAN  -- 是否启用云码验证
cloud_code_secret VARCHAR(32) -- 云码密钥
backup_codes TEXT           -- 备用验证码（JSON）
verification_method VARCHAR(20) -- 验证方式
last_login DATETIME         -- 最后登录时间
is_active BOOLEAN           -- 账户状态

-- 验证码表
verification_code (
    id INTEGER PRIMARY KEY,
    user_id INTEGER,
    code VARCHAR(10),
    code_type VARCHAR(20),
    expires_at DATETIME,
    used BOOLEAN,
    created_at DATETIME
)
```

### 配置说明

#### 生产环境配置
1. **HTTPS**：启用HTTPS以保护数据传输
2. **Cookie安全**：设置`secure=True`和`httponly=True`
3. **短信服务**：集成真实的短信API（如阿里云、腾讯云）
4. **邮件服务**：集成真实的邮件API（如SendGrid、Mailgun）

#### 安全建议
1. **定期更新**：定期更新依赖库
2. **监控日志**：监控异常登录尝试
3. **备份策略**：定期备份用户数据和验证码
4. **访问控制**：限制API访问频率

### 故障排除

#### 常见问题
1. **云码验证失败**
   - 检查时间同步
   - 重新扫描二维码
   - 使用备用验证码

2. **验证码未收到**
   - 检查邮箱/手机号是否正确
   - 检查垃圾邮件文件夹
   - 联系管理员重置

3. **无法登录**
   - 确认用户名密码正确
   - 检查云码应用是否正常工作
   - 使用备用验证方式

#### 管理员操作
1. **重置用户云码**：清除`cloud_code_secret`字段
2. **禁用用户**：设置`is_active=False`
3. **查看登录日志**：查询`Log`表

### 更新日志

#### v2.0.0 (当前版本)
- ✅ 集成云码验证系统
- ✅ 支持多种验证方式
- ✅ 渐进式安全升级
- ✅ 完善的安全设置界面
- ✅ 详细的日志记录

#### 计划功能
- 🔄 生物识别验证
- 🔄 设备信任管理
- 🔄 安全策略配置
- 🔄 实时安全监控
